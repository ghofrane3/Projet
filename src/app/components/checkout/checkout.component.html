<div class="checkout-page">
  <div class="container">
    <div class="checkout-header">
      <button class="back-btn" (click)="goBack()">‚Üê Retour</button>
      <h1>Paiement S√©curis√©</h1>
      <div class="checkout-steps">
        <div class="step active">Panier</div>
        <div class="step active">Information</div>
        <div class="step active">Paiement</div>
        <div class="step">Confirmation</div>
      </div>
    </div>

    <div *ngIf="paymentSuccess" class="payment-success">
      <div class="success-icon">‚úÖ</div>
      <h2>Paiement R√©ussi !</h2>
      <p>Votre transaction a √©t√© trait√©e avec succ√®s.</p>
      <p class="transaction-id">ID de transaction: {{ transactionId }}</p>
      <p>Redirection vers la confirmation de commande...</p>
    </div>

    <div *ngIf="!paymentSuccess" class="checkout-content">
      <div class="checkout-form-section">
        <h2>Informations de Livraison</h2>
        <form [formGroup]="checkoutForm" (ngSubmit)="processPayment()">
          <div class="form-grid">
            <div class="form-group">
              <label>Pr√©nom *</label>
              <input type="text" formControlName="firstName" placeholder="Votre pr√©nom">
              <div *ngIf="checkoutForm.get('firstName')?.invalid && checkoutForm.get('firstName')?.touched"
                   class="error-message">
                Pr√©nom requis (min 2 caract√®res)
              </div>
            </div>

            <div class="form-group">
              <label>Nom *</label>
              <input type="text" formControlName="lastName" placeholder="Votre nom">
              <div *ngIf="checkoutForm.get('lastName')?.invalid && checkoutForm.get('lastName')?.touched"
                   class="error-message">
                Nom requis (min 2 caract√®res)
              </div>
            </div>

            <div class="form-group">
              <label>Email *</label>
              <input type="email" formControlName="email" placeholder="votre@email.com">
              <div *ngIf="checkoutForm.get('email')?.invalid && checkoutForm.get('email')?.touched"
                   class="error-message">
                Email valide requis
              </div>
            </div>

            <div class="form-group">
              <label>T√©l√©phone *</label>
              <input type="tel" formControlName="phone" placeholder="XX XXX XXX">
              <div *ngIf="checkoutForm.get('phone')?.invalid && checkoutForm.get('phone')?.touched"
                   class="error-message">
                8 chiffres requis
              </div>
            </div>

            <div class="form-group full-width">
              <label>Adresse *</label>
              <input type="text" formControlName="address" placeholder="Votre adresse compl√®te">
              <div *ngIf="checkoutForm.get('address')?.invalid && checkoutForm.get('address')?.touched"
                   class="error-message">
                Adresse requise
              </div>
            </div>

            <div class="form-group">
              <label>Ville *</label>
              <input type="text" formControlName="city" placeholder="Votre ville">
              <div *ngIf="checkoutForm.get('city')?.invalid && checkoutForm.get('city')?.touched"
                   class="error-message">
                Ville requise
              </div>
            </div>

            <div class="form-group">
              <label>Code Postal *</label>
              <input type="text" formControlName="zipCode" placeholder="XXXX">
              <div *ngIf="checkoutForm.get('zipCode')?.invalid && checkoutForm.get('zipCode')?.touched"
                   class="error-message">
                4 chiffres requis
              </div>
            </div>
          </div>

          <h2>Informations de Paiement</h2>

          <div class="payment-methods">
            <div *ngFor="let method of paymentMethods"
                 [class.selected]="selectedPaymentMethod === method.id"
                 class="payment-method"
                 (click)="selectedPaymentMethod = method.id">
              <span class="method-icon">{{ method.icon }}</span>
              <div>
                <h4>{{ method.name }}</h4>
                <p>{{ method.description }}</p>
              </div>
            </div>
          </div>

          <div *ngIf="selectedPaymentMethod === 1" class="card-form">
            <div class="form-group">
              <label>Num√©ro de Carte *</label>
              <input type="text"
                     formControlName="cardNumber"
                     (input)="formatCardNumber($event)"
                     placeholder="1234 5678 9012 3456"
                     maxlength="19">
              <div *ngIf="checkoutForm.get('cardNumber')?.invalid && checkoutForm.get('cardNumber')?.touched"
                   class="error-message">
                16 chiffres requis
              </div>
            </div>

            <div class="form-group">
              <label>Titulaire de la Carte *</label>
              <input type="text" formControlName="cardHolder" placeholder="Nom comme sur la carte">
              <div *ngIf="checkoutForm.get('cardHolder')?.invalid && checkoutForm.get('cardHolder')?.touched"
                   class="error-message">
                Nom du titulaire requis
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Date d'Expiration *</label>
                <input type="text"
                       formControlName="expiryDate"
                       (input)="formatExpiryDate($event)"
                       placeholder="MM/AA"
                       maxlength="5">
                <div *ngIf="checkoutForm.get('expiryDate')?.invalid && checkoutForm.get('expiryDate')?.touched"
                     class="error-message">
                  Format MM/AA requis
                </div>
              </div>

              <div class="form-group">
                <label>CVV *</label>
                <input type="password"
                       formControlName="cvv"
                       placeholder="123"
                       maxlength="3">
                <div *ngIf="checkoutForm.get('cvv')?.invalid && checkoutForm.get('cvv')?.touched"
                     class="error-message">
                  3 chiffres requis
                </div>
              </div>
            </div>
          </div>

          <button type="submit" class="pay-btn" [disabled]="isProcessing || checkoutForm.invalid">
            <span *ngIf="!isProcessing">Payer {{ getTotal().toFixed(2) }} DT</span>
            <span *ngIf="isProcessing">Traitement en cours...</span>
          </button>
        </form>
      </div>

      <div class="order-summary">
        <h2>R√©capitulatif</h2>
        <div class="summary-items">
          <div *ngFor="let item of cartItems" class="summary-item">
            <img [src]="item.product.images[0]" [alt]="item.product.name">
            <div class="item-info">
              <h4>{{ item.product.name }}</h4>
              <p>{{ item.selectedSize }} | {{ item.selectedColor }}</p>
              <p>{{ item.quantity }} √ó {{ (item.product.discountPrice || item.product.price).toFixed(2) }} DT</p>
            </div>
            <div class="item-total">
              {{ ((item.product.discountPrice || item.product.price) * item.quantity).toFixed(2) }} DT
            </div>
          </div>
        </div>

        <div class="summary-totals">
          <div class="summary-row">
            <span>Sous-total</span>
            <span>{{ getSubtotal().toFixed(2) }} DT</span>
          </div>
          <div class="summary-row">
            <span>Livraison</span>
            <span>{{ getShippingCost().toFixed(2) }} DT</span>
          </div>
          <div class="summary-row total">
            <span>Total</span>
            <span>{{ getTotal().toFixed(2) }} DT</span>
          </div>
        </div>

        <div class="security-info">
          <div class="secure-badge">üîí</div>
          <p>Paiement 100% s√©curis√©</p>
          <small>Vos informations sont crypt√©es et prot√©g√©es</small>
        </div>
      </div>
    </div>
  </div>
</div>
